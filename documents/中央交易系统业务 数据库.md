# 中央交易系统业务 数据库

> D组 陈玮烨 孙克染 张梓欣 杨清杰

## 指令 Market Orders

根据之前我们提出的指令的关系，我们可以设计以下几个数据库。

#### 买指令 Bids

```mysql
-- 创建一个待交易的买指令(bid)表
create table Bids
(
	ID bigint,			 					-- 编号：唯一性的编号 作为指向该指令的索引
  time timestamp, 					-- 时间 
  UID varchar(10) not null,	-- 用户ID标识
  code varchar(5) not null, -- 代交易的股票代码 例如'BABA','MSFT'
  shares int not null,			-- 所有交易的股数
  price numeric(8,2) not null,	-- 交易的单价（元/股）[0-999999.99]
  shares2trade int,					-- 该指令中未被交易的部分的股数
  timeArchived timestamp default null, -- 被存档的时间（加入该关系的时间）
  status smallint,					-- 状态 0=complete, 1=expired, 2=partial
  primary key (ID),
  foreign key (UID) references users,
  foreign key (code) references companyList
)
```

价格的涨跌停限制、用户是否具有足够的资金购买、交易股数是否超过发行量等限制应当使用对该表insert的触发器来实现。

#### 卖指令 Asks

```mysql
-- 创建一个待交易的卖指令(aks)表
create table Asks
(
	ID bigint,			 					-- 编号：唯一性的编号 作为指向该指令的索引
  time timestamp, 					-- 时间 
  UID varchar(10) not null,	-- 用户ID标识
  code varchar(5) not null, -- 代交易的股票代码 例如'BABA','MSFT'
  shares int not null,			-- 所有交易的股数
  price numeric(8,2) not null,	-- 交易的单价（元/股）[0-999999.99]
  shares2trade int,					-- 该指令中未被交易的部分的股数
  timeArchived timestamp default null, -- 被存档的时间（加入该关系的时间）
  status smallint,					-- 状态 0=complete, 1=expired, 2=partial
  primary key (ID),
  foreign key (UID) references users,
  foreign key (code) references companyList
)
```

价格的涨跌停限制、用户是否具有足够的持仓抛售、交易股数是否超过发行量等限制应当使用对该表insert的触发器来实现。





## 撮合Match和成交Deal

我们把一个卖指令和另一个买指令的对应的交易称为撮合（Match），而一个卖指令/卖指令对应的所有的撮合叫做成交（Deal）。即一个成交对应多个撮合

#### 撮合Matchs

每新加入一个指令，我们触发触发器，查询是否有与其撮合的指令。

```mysql
-- 创建一个撮合表
create table Matchs
(
  matchID bigint,					-- 撮合编号
  askID varchar(10),			-- 卖指令编号
  bidID varchar(10),			-- 买指令编号
  shares int,							-- 交易数量
  askPrice numeric(8,2),	-- 卖指令价格
  bidPrice numeric(8,2),	-- 买指令价格
  matchPrice numeric(8,2),-- 撮合价格	
  matchTime timestamp,		-- 撮合时间
  code varchar(5) not null, -- 代交易的股票代码 例如'BABA','MSFT'
  primary key (matchID),
  foreign key (askID) references Asks,
  foreign key (bidID) references Bids,
  foreign key (code) references companyList
)
```

#### 成交

```mysql
-- 卖方的成交表
create table DealsAsk
(
	ID bigint,					-- 卖指令编号
  shares int,					-- 指令规定的交易数
  sharesDealed int,		-- 成交数
  price numeric(8,2),	-- 成交价格(单价)
  time timestamp,
  code varchar(5) not null, -- 代交易的股票代码 例如'BABA','MSFT'
  foreign key (code) references companyList
)
```



```mysql
-- 买方的成交表
create table DealsBid
(
	ID bigint,					-- 卖指令编号
  shares int,					-- 指令规定的交易数
  sharesDealed int,		-- 成交数
  price numeric(8,2),	-- 成交价格(单价)
  time timestamp,
  code varchar(5) not null, -- 代交易的股票代码 例如'BABA','MSFT'
  foreign key (code) references CompanyList
)
```

